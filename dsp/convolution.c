/* --------------------------------------------------- */
/* インパルス応答波形の畳み込み積分計算プログラム      */
/* Written by 辻岡哲夫                                 */
/* Powered by 情報通信領域, Osaka City University      */
/* --------------------------------------------------- */

/* 2001.12.13 (Thu) */
/* 2003.01.14 revised */
/* 2010.01.12 (Tue) revised */
/* 2014.01.13 (Tue) revised */

/* RIFFサブルーチンの読み込み */
#include "riff.c"

/* --- Generic Convolution ------------------------------------------ */

/* インパルス応答の設定 */
int set_impulse_response(double *h, int type)
{
  int N;
  int i;

  switch (type) {
  case 0:
    /* 4-tap 移動平均フィルタの係数 */
    N = 4;
    h[0] = 1.0 / N;
    h[1] = 1.0 / N;
    h[2] = 1.0 / N;
    h[3] = 1.0 / N;
    break;
  case 1:
    /* 16-tap 移動平均フィルタの係数 */
    N = 16;
    for (i = 0; i < N; i++) {
      h[i] = 1.0 / N;
    }
    break;
  case 10:
    /* 15-tap LPF (BW = 0.200) の係数*/
    N = 15;
    h[0]=-0.0432472;  h[1]=-0.0311830;  h[2]= 0.0000000;  h[3]= 0.0467745;
    h[4]= 0.1009102;  h[5]= 0.1513653;  h[6]= 0.1870979;  h[7]= 0.2000000;
    h[8]= 0.1870979;  h[9]= 0.1513653;  h[10]= 0.1009102;  h[11]= 0.0467745;
    h[12]= 0.0000000;  h[13]=-0.0311830;  h[14]=-0.0432472;
    break;
  case 11:
    /* 31-tap LPF (BW = 0.100) の係数 */
    N = 31;
    h[0]=-0.0212207;  h[1]=-0.0216236;  h[2]=-0.0198091;  h[3]=-0.0155915;
    h[4]=-0.0089421;  h[5]= 0.0000000;  h[6]= 0.0109292;  h[7]= 0.0233872;
    h[8]= 0.0367883;  h[9]= 0.0504551;  h[10]= 0.0636620;  h[11]= 0.0756827;
    h[12]= 0.0858394;  h[13]= 0.0935489;  h[14]= 0.0983632;  h[15]= 0.1000000;
    h[16]= 0.0983632;  h[17]= 0.0935489;  h[18]= 0.0858394;  h[19]= 0.0756827;
    h[20]= 0.0636620;  h[21]= 0.0504551;  h[22]= 0.0367883;  h[23]= 0.0233872;
    h[24]= 0.0109292;  h[25]= 0.0000000;  h[26]=-0.0089421;  h[27]=-0.0155915;
    h[28]=-0.0198091;  h[29]=-0.0216236;  h[30]=-0.0212207;
    break;
  case 13:
    /* 63-tap LPF (BW = 0.100) の係数 */ /* ブラックマン窓 */
    N = 63;
    h[0]=-2.7620e-06; h[1]=1.3712e-20;  h[2]=2.7295e-05;  h[3]=9.7750e-05;  
    h[4]=2.2399e-04;  h[5]=4.0612e-04;  h[6]=6.2519e-04;  h[7]=8.3814e-04;  
    h[8]=9.7629e-04;  h[9]=9.4910e-04;  h[10]=6.5508e-04; h[11]=-6.7081e-19;
    h[12]=-1.0786e-03;h[13]=-2.5835e-03;h[14]=-4.4313e-03;h[15]=-6.4330e-03;
    h[16]=-8.2876e-03;h[17]=-9.5930e-03;h[18]=-9.8773e-03;h[19]=-8.6497e-03;
    h[20]=-5.4659e-03;h[21]=2.6007e-18; h[22]=7.8864e-03; h[23]=1.8091e-02; 
    h[24]=3.0244e-02; h[25]=4.3712e-02; h[26]=5.7640e-02; h[27]=7.1029e-02; 
    h[28]=8.2834e-02; h[29]=9.2080e-02; h[30]=9.7975e-02; h[31]=1.0000e-01; 
    h[32]=9.7975e-02; h[33]=9.2080e-02; h[34]=8.2834e-02; h[35]=7.1029e-02; 
    h[36]=5.7640e-02; h[37]=4.3712e-02; h[38]=3.0244e-02; h[39]=1.8091e-02; 
    h[40]=7.8864e-03; h[41]=2.6007e-18; h[42]=-5.4659e-03;h[43]=-8.6497e-03;
    h[44]=-9.8773e-03;h[45]=-9.5930e-03;h[46]=-8.2876e-03;h[47]=-6.4330e-03;
    h[48]=-4.4313e-03;h[49]=-2.5835e-03;h[50]=-1.0786e-03;h[51]=-6.7081e-19;
    h[52]=6.5508e-04; h[53]=9.4910e-04; h[54]=9.7629e-04; h[55]=8.3814e-04; 
    h[56]=6.2519e-04; h[57]=4.0612e-04; h[58]=2.2399e-04; h[59]=9.7750e-05; 
    h[60]=2.7295e-05; h[61]=1.3712e-20; h[62]=-2.7620e-06;
    break;
  case 20:
    /* 差分フィルタの係数 */
    N = 2;
    h[0] = 1;
    h[1] = -1;
    break;
  case 30:
    /* ECHO (delay=25ms) の係数 */
    N = 1000;
    for (i = 0; i < 1000; i++) {
      h[i] = 0;
    }
    h[0] = 0.8;
    h[699] = 0.4;
    h[999] = 0.2;
    break;
  case 51:
    /* LPF (B=0.05) : 低域 */
    /* h_calc.c 0 */
    N = 31;
    h[0]= 0.0150053;  h[1]= 0.0183942;  h[2]= 0.0218166;  h[3]= 0.0252276;  
    h[4]= 0.0285810;  h[5]= 0.0318310;  h[6]= 0.0349323;  h[7]= 0.0378413;  
    h[8]= 0.0405166;  h[9]= 0.0429197;  h[10]= 0.0450158; h[11]= 0.0467745; 
    h[12]= 0.0481699; h[13]= 0.0491816; h[14]= 0.0497946; h[15]= 0.0500000; 
    h[16]= 0.0497946; h[17]= 0.0491816; h[18]= 0.0481699; h[19]= 0.0467745; 
    h[20]= 0.0450158; h[21]= 0.0429197; h[22]= 0.0405166; h[23]= 0.0378413; 
    h[24]= 0.0349323; h[25]= 0.0318310; h[26]= 0.0285810; h[27]= 0.0252276; 
    h[28]= 0.0218166; h[29]= 0.0183942; h[30]= 0.0150053; 
    break;
  case 52:
    /* HPF (B=0.5) : 高域 */
    /* h_calc.c 1 */
    N = 31;
    h[0]= 0.0212207;  h[1]=-0.0000000;  h[2]=-0.0244854;  h[3]= 0.0000000;  
    h[4]= 0.0289373;  h[5]=-0.0000000;  h[6]=-0.0353678;  h[7]= 0.0000000;  
    h[8]= 0.0454728;  h[9]=-0.0000000;  h[10]=-0.0636620; h[11]= 0.0000000; 
    h[12]= 0.1061033; h[13]=-0.0000000; h[14]=-0.3183099; h[15]= 0.5000000; 
    h[16]=-0.3183099; h[17]=-0.0000000; h[18]= 0.1061033; h[19]= 0.0000000; 
    h[20]=-0.0636620; h[21]=-0.0000000; h[22]= 0.0454728; h[23]= 0.0000000; 
    h[24]=-0.0353678; h[25]=-0.0000000; h[26]= 0.0289373; h[27]= 0.0000000; 
    h[28]=-0.0244854; h[29]=-0.0000000; h[30]= 0.0212207; 
    break;
  case 53:
    /* BRF (B=0.05〜0.5) */
    /* h_calc.c 2 */
    N = 31;
    h[0]= 0.0362259;  h[1]= 0.0183942;  h[2]=-0.0026687;  h[3]= 0.0252276;  
    h[4]= 0.0575183;  h[5]= 0.0318310;  h[6]=-0.0004354;  h[7]= 0.0378413;  
    h[8]= 0.0859894;  h[9]= 0.0429197;  h[10]=-0.0186462; h[11]= 0.0467745; 
    h[12]= 0.1542732; h[13]= 0.0491816; h[14]=-0.2685152; h[15]= 0.5500000; 
    h[16]=-0.2685152; h[17]= 0.0491816; h[18]= 0.1542732; h[19]= 0.0467745; 
    h[20]=-0.0186462; h[21]= 0.0429197; h[22]= 0.0859894; h[23]= 0.0378413; 
    h[24]=-0.0004354; h[25]= 0.0318310; h[26]= 0.0575183; h[27]= 0.0252276; 
    h[28]=-0.0026687; h[29]= 0.0183942; h[30]= 0.0362259; 
    break;
  case 54:
    /* BPF (B=0.05〜0.5) : 中域 */
    /* h_calc.c 3 */
    N = 31;
    h[0]=-0.0362259;  h[1]=-0.0183942;  h[2]= 0.0026687;  h[3]=-0.0252276;  
    h[4]=-0.0575183;  h[5]=-0.0318310;  h[6]= 0.0004354;  h[7]=-0.0378413;  
    h[8]=-0.0859894;  h[9]=-0.0429197;  h[10]= 0.0186462; h[11]=-0.0467745; 
    h[12]=-0.1542732; h[13]=-0.0491816; h[14]= 0.2685152; h[15]= 0.4500000; 
    h[16]= 0.2685152; h[17]=-0.0491816; h[18]=-0.1542732; h[19]=-0.0467745; 
    h[20]= 0.0186462; h[21]=-0.0429197; h[22]=-0.0859894; h[23]=-0.0378413; 
    h[24]= 0.0004354; h[25]=-0.0318310; h[26]=-0.0575183; h[27]=-0.0252276; 
    h[28]= 0.0026687; h[29]=-0.0183942; h[30]=-0.0362259; 
    break;
  case 55:
    /* 3バンド・イコライザ (低域 1.0倍, 中域 0.4倍, 高域 0.8倍)*/
    /* h_calc.c 4 */
    N = 31;
    h[0]= 0.0174914;  h[1]= 0.0110365;  h[2]= 0.0032958;  h[3]= 0.0151365;  
    h[4]= 0.0287235;  h[5]= 0.0190986;  h[6]= 0.0068123;  h[7]= 0.0227048;  
    h[8]= 0.0424991;  h[9]= 0.0257518;  h[10]= 0.0015447; h[11]= 0.0280647; 
    h[12]= 0.0713433; h[13]= 0.0295089; h[14]=-0.0974472; h[15]= 0.6300000; 
    h[16]=-0.0974472; h[17]= 0.0295089; h[18]= 0.0713433; h[19]= 0.0280647; 
    h[20]= 0.0015447; h[21]= 0.0257518; h[22]= 0.0424991; h[23]= 0.0227048; 
    h[24]= 0.0068123; h[25]= 0.0190986; h[26]= 0.0287235; h[27]= 0.0151365; 
    h[28]= 0.0032958; h[29]= 0.0110365; h[30]= 0.0174914; 
    break;
  case 99:
    /* チェック用 */
#include "h_calc.inc"
    /*
○bashの時
gcc -Wall h_calc.c -o h_calc -lm; ./h_calc 3 1> h_calc.out 2> h_calc.inc; \
cc -Wall convolution.c -o convolution; \
cat h_calc.out | h_ftoku | xgraph -ly 0,1.4 -m
○tcshの時
gcc -Wall h_calc.c -o h_calc -lm; (./h_calc 3 >! h_calc.out) >&! h_calc.inc; \
gcc -Wall convolution.c -o convolution; \
cat h_calc.out | h_ftoku | xgraph -ly 0,1.4 -m
    */
  default:
    fprintf(stderr, "error: unknown response type\n");
    exit(2);
  }

  return (N);
}

/* フィルタ処理 */
void do_filter(struct waveform_s *x, struct waveform_s *y, int type)
{
  int i, k, m, ch;
  int count;
  double sum;

  int N;
  double h[1000];

  /* 係数の初期設定 */
  N = set_impulse_response(h, type);

  /* 畳み込み積分 */
  count = x->datasize / sizeof(WAVE_T);

  for (ch = 0; ch < 2; ch++) { /* ch=0: L-ch, ch=1: R-ch */
    for (i = 0; i < count; i++) {
      /* 積分値の初期化 */
      sum = 0.0;
      /* 積分計算 */
      for (k = 0; k < N; k++) {
	m = i - k;
	if (m >= 0 && m < count) {
	  sum += h[k] * (double)x->data[m].ch[ch];
	}
      }

#if 0
      // ギプス現象による音割れを緩和する
      // あらかじめ15bit程度のサウンドレベルにしておけば不要
      sum *= 0.5;
#endif

#if 1
      /* クリッピング処理 */
      if (sum >= 32767.0) sum = 32767.0;
      else if (sum < -32767.0) sum = -32767.0;
#endif

      /* 計算結果の代入 */
      y->data[i].ch[ch] = (CH_T)sum;
    }
  }
}

/* --- MAIN PROGRAM ------------------------------------------------- */

/* src_fname と h(t) を畳み込み積分し，out_fname に出力する */
void convolution(char *src_fname, char *out_fname, int type)
{
  struct waveform_s wf_x, wf_y;

  /* 波形 x(t) の読み込み */
  load_waveform(src_fname, &wf_x);

#if 0
  /* データサイズが大きいとき，途中までの処理とする */
  if (wf_x.datasize > 3000000) wf_x.datasize = 3000000;
#endif

  /* 波形 y(t) の初期化 */
  wf_y = wf_x;
  wf_y.data = m_alloc(wf_x.datasize);

  /* 波形 y(t) の計算 (畳み込み積分) */
  do_filter(&wf_x, &wf_y, type);

  /* 波形 y(t) の保存 */
  save_waveform(out_fname, &wf_y);
}

int main(int argc, char **argv)
{
  char *src_fname, *out_fname;
  int type;

  if (argc != 4) {
    fprintf(stderr, "usage: convolution <src_fname> <out_fname> <type>\n");
    fprintf(stderr, "   ex: convolution sweep.wav output.wav 0\n");
    fprintf(stderr, "type=0  : 4-tap 移動平均フィルタ\n");
    fprintf(stderr, "type=1  : 16-tap 移動平均フィルタ\n");
    fprintf(stderr, "type=10 : 15-tap LPF (BW = 0.200)\n");
    fprintf(stderr, "type=11 : 31-tap LPF (BW = 0.100)\n");
    fprintf(stderr, "type=12 : 63-tap LPF (BW = 0.050) + blackman\n");
    fprintf(stderr, "type=13 : 63-tap LPF (BW = 0.100) + blackman\n");
    fprintf(stderr, "type=20 : 差分フィルタ\n");
    fprintf(stderr, "type=30 : ECHO (delay=25ms)\n");
    exit(2);
  }

  src_fname = argv[1];
  out_fname = argv[2];
  type      = atoi(argv[3]);

  convolution(src_fname, out_fname, type);

  return (0);
}

